<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Form Input Data Invoice</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        margin: 0;
        padding: 20px;
    }
    .container {
        max-width: 700px;
        margin: auto;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    h2 {
        text-align: center;
        color: #333;
    }
    .form-group {
        margin-bottom: 15px;
    }
    label {
        font-weight: bold;
        display: block;
        margin-bottom: 5px;
    }
    input, select, textarea, button {
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 16px;
        width: 100%;
        box-sizing: border-box;
    }
    textarea {
        resize: vertical;
    }
    button {
        cursor: pointer;
    }
    .btn-submit {
        background-color: #5cb85c;
        color: white;
        border: none;
        margin-top: 10px;
    }
    .btn-submit:hover {
        background-color: #4cae4c;
    }
    .btn-preview {
        background-color: #0275d8;
        color: white;
        border: none;
        margin-top: 10px;
        margin-right: 10px;
    }
    .btn-preview:hover {
        background-color: #025aa5;
    }
    #response-message {
        margin-top: 20px;
        font-weight: bold;
        color: green;
    }
    #invoice-preview {
        background: white;
        margin-top: 30px;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 8px rgba(0,0,0,0.1);
        font-family: Arial, sans-serif;
        font-size: 14px;
        max-width: 700px;
        margin-left: auto;
        margin-right: auto;
    }
    table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 20px;
    }
    table, th, td {
        border: 1px solid black;
    }
    th, td {
        padding: 6px;
        text-align: left;
    }
    th {
        background-color: #f2f2f2;
    }
    .right {
        text-align: right;
    }
    .prepared {
        margin-top: 60px;
        margin-bottom: 50px;
    }
    .passenger-row {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }
    .passenger-row > input {
        flex: 1;
    }
    .passenger-row > button {
        flex: 0 0 30px;
        background-color: #d9534f;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
    }
    .passenger-row > button:hover {
        background-color: #c9302c;
    }
</style>
</head>
<body>

<div class="container">
    <h2>Form Input Data Invoice</h2>

    <div class="form-group">
        <label for="date">Date</label>
        <input type="date" id="date" />
    </div>

    <div class="form-group">
        <label for="due-date">Due Date</label>
        <input type="date" id="due-date" />
    </div>

    <div class="form-group">
        <label for="customer-name">To (Customer Name)</label>
        <select id="customer-name" onchange="updateCustomerAddress()">
            <option value="">Pilih Customer</option>
            <option value="PT Alpha">PT Alpha</option>
            <option value="PT Beta">PT Beta</option>
            <option value="PT Gamma">PT Gamma</option>
            <option value="Custom">Custom</option>
        </select>
        <input type="text" id="custom-customer-name" style="display:none; margin-top:8px;" placeholder="Masukkan Nama Customer" />
        <button id="reset-customer" style="display:none; margin-top:8px;" onclick="resetCustomer()">Reset Customer</button>
    </div>

    <div class="form-group">
        <label for="customer-address">Customer Address</label>
        <input type="text" id="customer-address" placeholder="Alamat Customer" readonly />
    </div>

    <div class="form-group">
        <label for="invoice-no">Invoice No</label>
        <input type="text" id="invoice-no" placeholder="Masukkan nomor invoice" />
    </div>

    <h3>Passenger / Produk</h3>
    <div id="passengers-container"></div>
    <button type="button" onclick="addPassengerRow()" style="margin-bottom: 20px;">Tambah Penumpang / Produk</button>

    <div class="form-group">
        <label for="service-fee">Service Fee (Rp)</label>
        <input type="number" id="service-fee" placeholder="Masukkan service fee" value="0" min="0" />
    </div>

    <div>
        <button class="btn-preview" onclick="previewInvoice()">Preview Invoice</button>
        <button class="btn-submit" onclick="submitInvoice()">Submit Invoice</button>
    </div>

    <div id="response-message"></div>
</div>

<div id="invoice-preview"></div>

<script>
    // Customer data
    const customerData = {
        "PT Alpha": "Alamat PT Alpha",
        "PT Beta": "Alamat PT Beta",
        "PT Gamma": "Alamat PT Gamma"
    };

    // Auto set date and due date
    const dateInput = document.getElementById('date');
    const dueDateInput = document.getElementById('due-date');
    dateInput.valueAsDate = new Date();
    setDueDate();
    dateInput.addEventListener('change', setDueDate);

    function setDueDate() {
        if(dateInput.value){
            let dt = new Date(dateInput.value);
            dt.setDate(dt.getDate() + 7);
            dueDateInput.valueAsDate = dt;
        }
    }

    // Update customer address
    function updateCustomerAddress() {
        const select = document.getElementById('customer-name');
        const customInput = document.getElementById('custom-customer-name');
        const address = document.getElementById('customer-address');
        const resetBtn = document.getElementById('reset-customer');
        const val = select.value;

        if(val === 'Custom'){
            select.style.display = 'none';
            customInput.style.display = 'block';
            customInput.focus();
            address.readOnly = false;
            address.value = '';
            resetBtn.style.display = 'inline-block';
        } else {
            select.style.display = 'block';
            customInput.style.display = 'none';
            address.readOnly = true;
            address.value = customerData[val] || '';
            resetBtn.style.display = 'none';
        }
    }

    // Reset customer select
    function resetCustomer() {
        const select = document.getElementById('customer-name');
        const customInput = document.getElementById('custom-customer-name');
        const address = document.getElementById('customer-address');
        const resetBtn = document.getElementById('reset-customer');

        select.style.display = 'block';
        select.value = '';
        customInput.style.display = 'none';
        customInput.value = '';
        address.readOnly = true;
        address.value = '';
        resetBtn.style.display = 'none';
    }

    // Add initial passenger row
    const passengersContainer = document.getElementById('passengers-container');
    addPassengerRow();

    // Function to add passenger/produk input row
    function addPassengerRow(data = {}) {
        const div = document.createElement('div');
        div.className = 'passenger-row';

        div.innerHTML = `
            <input type="text" placeholder="Nama Penumpang / Produk" class="passenger-name" value="${data.passenger_name || ''}" required />
            <input type="text" placeholder="Deskripsi" class="description" value="${data.description || ''}" />
            <input type="text" placeholder="Maskapai" class="airline" value="${data.airline || ''}" />
            <input type="text" placeholder="Nomor Tiket" class="ticket-no" value="${data.ticket_no || ''}" />
            <input type="number" placeholder="Tarif (Rp)" class="fare passenger-fare" min="0" value="${data.fare || ''}" required />
            <button type="button" onclick="removePassengerRow(this)">Ã—</button>
        `;

        passengersContainer.appendChild(div);
    }

    // Remove passenger row
    function removePassengerRow(btn) {
        passengersContainer.removeChild(btn.parentElement);
    }

    // Hitung total tarif semua penumpang
    function calculateTotals() {
        const fareInputs = document.querySelectorAll('.passenger-fare');
        let totalFare = 0;
        fareInputs.forEach(input => {
            totalFare += Number(input.value) || 0;
        });
        const serviceFee = Number(document.getElementById('service-fee').value) || 0;
        const grandTotal = totalFare + serviceFee;
        return { totalFare, serviceFee, grandTotal };
    }

    // Render invoice preview
    function renderInvoicePreview(data) {
        let passengerRowsHtml = '';
        data.passengers.forEach((p, i) => {
            passengerRowsHtml += `
                <tr>
                    <td>${i + 1}</td>
                    <td>${p.passenger_name}</td>
                    <td>${p.description}</td>
                    <td>${p.airline}</td>
                    <td>${p.ticket_no}</td>
                    <td class="right">${Number(p.fare).toLocaleString('id-ID')}</td>
                </tr>
            `;
        });

        const invoiceHtml = `
            <div style="font-family: Arial, sans-serif; font-size:14px; margin: 20px;">
                <div style="text-align:left; margin-bottom: 20px;">
                    <img src="https://drive.google.com/uc?export=view&id=11IT2mQu24QjycJwdPCPDdNRnO5W2xDNQ" alt="Logo" style="width:120px; height:auto;" />
                </div>
                <div style="text-align:center; font-weight:bold; font-size:18px; margin-bottom: 20px;">
                    TRAVEL SERVICE INVOICE
                </div>

                <div>
                    <p>Date: ${data.date}</p>
                    <p>Due Date: ${data.due_date}</p>
                </div>

                <div>
                    <p>To: <strong>${data.customer_name}</strong></p>
                    <p>${data.customer_address}</p>
                    <p>Invoice No: <strong>${data.invoice_number}</strong></p>
                </div>

                <table>
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>NAME OF PASSENGER</th>
                            <th>DESCRIPTION</th>
                            <th>AIRLINES</th>
                            <th>TICKET NO</th>
                            <th class="right">TOTAL FARE</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${passengerRowsHtml}
                    </tbody>
                </table>

                <table style="margin-top: 10px; width: 50%; float: right;">
                    <tr>
                        <td class="total">TOTAL</td>
                        <td class="right">Rp ${data.totalFare.toLocaleString('id-ID')}</td>
                    </tr>
                    <tr>
                        <td class="total">SERVICE FEE</td>
                        <td class="right">Rp ${data.serviceFee.toLocaleString('id-ID')}</td>
                    </tr>
                    <tr>
                        <td class="total">GRAND TOTAL</td>
                        <td class="right">Rp ${data.grandTotal.toLocaleString('id-ID')}</td>
                    </tr>
                </table>

                <div style="clear: both;"></div>

                <div class="prepared">
                    <p style="margin-top: 60px; margin-bottom: 30px;"><strong>Prepared by:</strong></p>
                    <p style="margin-top: 10px; margin-bottom: 50px;"><strong>(Lilis)</strong></p>
                    <p>PAYMENT</p>
                    <p>MAYBANK: A/C 2737.000.566(IDR)</p>
                    <p>BENEFICIARY: PT PRATAMA ALHABINA WISATA</p>
                </div>
            </div>
        `;

        document.getElementById('invoice-preview').innerHTML = invoiceHtml;
    }

    // Ambil data form ke objek
    function getFormData() {
        const customerNameSelect = document.getElementById('customer-name');
        const customInput = document.getElementById('custom-customer-name');
        const customerName = customerNameSelect.style.display === 'none' ? customInput.value.trim() : customerNameSelect.value.trim();

        // Kumpulkan data penumpang
        const passengerRows = document.querySelectorAll('.passenger-row');
        const passengers = [];
        passengerRows.forEach(row => {
            const pName = row.querySelector('.passenger-name').value.trim();
            const desc = row.querySelector('.description').value.trim();
            const airline = row.querySelector('.airline').value.trim();
            const ticketNo = row.querySelector('.ticket-no').value.trim();
            const fare = row.querySelector('.fare').value.trim();

            if(pName && fare){
                passengers.push({
                    passenger_name: pName,
                    description: desc,
                    airline: airline,
                    ticket_no: ticketNo,
                    fare: Number(fare)
                });
            }
        });

        const { totalFare, serviceFee, grandTotal } = calculateTotals();

        return {
            date: document.getElementById('date').value,
            due_date: document.getElementById('due-date').value,
            customer_name: customerName,
            customer_address: document.getElementById('customer-address').value.trim(),
            invoice_number: document.getElementById('invoice-no').value.trim(),
            passengers: passengers,
            totalFare: totalFare,
            serviceFee: serviceFee,
            grandTotal: grandTotal
        };
    }

    // Preview button handler
    function previewInvoice() {
        const data = getFormData();

        if(!data.customer_name){
            alert("Mohon pilih atau isi nama customer.");
            return;
        }
        if(data.passengers.length === 0){
            alert("Mohon isi minimal 1 penumpang/produk dengan tarif.");
            return;
        }

        renderInvoicePreview(data);
    }

    // Submit invoice ke webhook n8n
    async function submitInvoice() {
        const data = getFormData();

        if(!data.customer_name){
            alert("Mohon pilih atau isi nama customer.");
            return;
        }
        if(data.passengers.length === 0){
            alert("Mohon isi minimal 1 penumpang/produk dengan tarif.");
            return;
        }

        const responseMessage = document.getElementById('response-message');
        responseMessage.style.color = 'black';
        responseMessage.textContent = 'Mengirim data...';

        try {
            const webhookUrl = 'https://n8n-mwjjuprcz1ho.ciluba.sumopod.my.id/webhook-test/webhook-test/invoice'; // ganti sesuai webhook kamu

            const response = await fetch(webhookUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data),
            });

            if(!response.ok){
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const result = await response.json();

            if(result.pdfLink){
                responseMessage.style.color = 'green';
                responseMessage.innerHTML = `Invoice berhasil dibuat! <a href="${result.pdfLink}" target="_blank">Download PDF</a>`;
            } else {
                responseMessage.style.color = 'green';
                responseMessage.textContent = 'Invoice berhasil dibuat!';
            }
        } catch (error) {
            responseMessage.style.color = 'red';
            responseMessage.textContent = `Gagal mengirim data: ${error.message}`;
            console.error('Error:', error);
        }
    }
</script>

</body>
</html>
